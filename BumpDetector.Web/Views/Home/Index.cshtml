@{
    ViewBag.Title = "Home Page";
}

<div class="jumbotron">
    <h1>Bump Detector</h1>
</div>

<div class="row">
    <div class="col-md-12">
        <h2>Instructions to simulate a match</h2>
        <p>In order to simulate a match you need to proceed with the following:</p>
        <ul>
            <li>Open this page on another tab/browser</li>
            <li>Fill out the fields - The matchmaking algorithm takes into account a distance up to 20m between two devices</li>
            <li style="color: orange">We're not considering values for Altitude nor for Timestamp yet. The reason is because some Android devices don't get Altitude values when not using GPS and the time is got directly in the server.</li>
            <li>Hit 'Send' on both pages. For testing purposes we're using a time range of 1 minute. That will decrease later.</li>
            <li>If a match occurs a message will be displayed below the device's information.</li>
            <li>If you're interested in logs, we provide some on the 'Logs' panel below.</li>
        </ul>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <h2>Device</h2>
        <input type="text" readonly="readonly" disabled="disabled" id="device"/>
    </div>
</div>
<br/>
<div class="row">
    <div class="col-md-3">
        <div>
            <label for="latitude">Latitude</label>
            <input type="text" id="latitude" value="-27.5965"/>
        </div>
    </div>
    <div class="col-md-3">
        <div>
            <label for="longitude">Longitude</label>
            <input type="text" id="longitude" value="-48.5205"/>
        </div>
    </div>
    <div class="col-md-3">
        <div>
            <label for="altitude">Altitude</label>
            <input type="text" id="altitude" value="0"/>
        </div>
    </div>
    <div class="col-md-3">
        <div>
            <label for="timestamp">Timestamp</label>
            <input type="text" id="timestamp" value="0" />
        </div>
    </div>
</div>
<div class="row">
    <input type="button" id="sendmessage" value="Send"/>
    <ul id="discussion"></ul>
</div>
<h2>Logs</h2>
<div class="jumbotron">
    <div id="log"></div>
</div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.bumpHub;
            // Create a function that the hub can call back to display messages.
            chat.client.bumpDetected = function (deviceId, message) {
                // Add the message to the page.
                $('#discussion').append('<li><strong>' + htmlEncode(deviceId) + '</strong>: ' + htmlEncode(message) + '</li>');
            };

            chat.client.log = function (message) {
                if (message.toLowerCase().indexOf("# ") !== -1) {
                    $('#log').append('<p style="font-size:0.7em;color: cornflowerblue;"><strong>' + htmlEncode(message) + '</strong></p>');
                } else {
                    $('#log').append('<p style="font-size:0.7em;">' + htmlEncode(message) + '</p>');
                }
            };
            // Get the user name and store it to prepend to messages.
            $('#device').val(prompt('Enter an id for the device:', 1));
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.newBump(
                        $('#device').val(),
                        $('#latitude').val(),
                        $('#longitude').val(),
                        $('#altitude').val(),
                        $('#timestamp').val());
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}